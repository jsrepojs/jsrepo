name: Bundle Analyze

on:
    pull_request:
        branches:
            - next

jobs:
    bundle-analyze:
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write

        steps:
            - uses: actions/checkout@v4
            - uses: pnpm/action-setup@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: pnpm

            - name: Install dependencies
              run: pnpm install

            - name: Build bundle analyzer
              run: pnpm --filter bundle-analyzer build

            - name: Build packages
              run: pnpm build:packages

            - name: Bundle Analyze
              id: analyze
              continue-on-error: true
              run: |
                  results="[]"
                  for package in packages/*/; do
                      if [ -f "$package/package.json" ]; then
                          package_name=$(jq -r '.name' "$package/package.json" 2>/dev/null || basename "$package")
                          size_json=$(node bundle-analyzer/dist/index.js analyze "$package" --json 2>/dev/null | tr -d '\n' || echo '{"size":0}')
                          if echo "$size_json" | jq -e '.size' > /dev/null 2>&1; then
                              results=$(echo "$results" | jq --arg name "$package_name" --argjson size_json "$size_json" '. += [{"name": $name, "size": ($size_json | .size)}]')
                          fi
                      fi
                  done
                  echo "$results" > bundle-results.json

            - name: Generate PR comment
              id: comment
              continue-on-error: true
              run: |
                  if [ -f bundle-results.json ]; then
                      cat > comment-body.txt << 'EOF'
                  ## ðŸ“¦ Bundle Size Analysis

                  | Package | Unpacked Size |
                  |---------|---------------|
                  EOF
                      jq -r 'sort_by(-.size) | .[] | (.size / 1024 / 1024) as $mb | (.size / 1024) as $kb | if $mb >= 1 then "| `\(.name)` | \($mb | sprintf("%.2f")) MB |" elif $kb >= 1 then "| `\(.name)` | \($kb | sprintf("%.2f")) KB |" else "| `\(.name)` | \(.size) B |" end' bundle-results.json >> comment-body.txt || echo "| *Failed to parse results* | - |" >> comment-body.txt
                  else
                      echo "## ðŸ“¦ Bundle Size Analysis

                  âš ï¸ Bundle analysis did not produce output." > comment-body.txt
                  fi

            - name: Create or update PR comment
              continue-on-error: true
              uses: peter-evans/create-or-update-comment@v4
              with:
                  issue-number: ${{ github.event.pull_request.number }}
                  comment-id: bundle-analyze
                  body-path: comment-body.txt
                  edit-mode: replace
